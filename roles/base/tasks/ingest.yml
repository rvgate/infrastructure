---
- name: nginx default page
  docker_container:
    name: default
    image: nginx
    state: started
    env:
      VIRTUAL_HOST: "{{ domain }}"

- name: nginx ingest
  docker_container:
    name: ingest
    image: nginxproxy/nginx-proxy
    state: started
    restart_policy: always
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - /etc/letsencrypt:/etc/letsencrypt
      - /etc/nginx/certs:/etc/nginx/certs
    env:
      DEFAULT_HOST: "{{ domain }}"

- name: restart ingest container weekly
  cron:
    name: restart ingest to reload certificates
    special_time: weekly
    job: /usr/bin/docker restart ingest > /dev/null
